<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>嘛,说说我与Astral的故事吧(第一弹) - 一只菜鸡的成长之路</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="scnace" /><meta name="description" content="嘛,说说我和Astral的故事吧(第一弹) From Wechat bot to Telegram bot 在序篇中,我曾提到写Astral的初衷是个Wechat Bot,所以,在引入了wecha" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.55.5 with even 4.0.0" />


<link rel="canonical" href="https://blog.scnace.me/post/the-story-about-astal-and-me-1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="嘛,说说我与Astral的故事吧(第一弹)" />
<meta property="og:description" content="嘛,说说我和Astral的故事吧(第一弹) From Wechat bot to Telegram bot 在序篇中,我曾提到写Astral的初衷是个Wechat Bot,所以,在引入了wecha" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.scnace.me/post/the-story-about-astal-and-me-1/" />


<meta itemprop="name" content="嘛,说说我与Astral的故事吧(第一弹)">
<meta itemprop="description" content="嘛,说说我和Astral的故事吧(第一弹) From Wechat bot to Telegram bot 在序篇中,我曾提到写Astral的初衷是个Wechat Bot,所以,在引入了wecha">



<meta itemprop="wordCount" content="1642">



<meta itemprop="keywords" content="Astral," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="嘛,说说我与Astral的故事吧(第一弹)"/>
<meta name="twitter:description" content="嘛,说说我和Astral的故事吧(第一弹) From Wechat bot to Telegram bot 在序篇中,我曾提到写Astral的初衷是个Wechat Bot,所以,在引入了wecha"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">scnace</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">scnace</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">嘛,说说我与Astral的故事吧(第一弹)</h1>

      <div class="post-meta">
        <span class="post-time"> 0001-01-01 </span>
        <div class="post-category">
            <a href="/categories/%E4%BC%AA%E6%8A%80%E6%9C%AF%E7%9B%B8%E5%85%B3/"> 伪技术相关 </a>
            </div>
          <span class="more-meta"> 1642 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#嘛-说说我和astral的故事吧-第一弹">嘛,说说我和Astral的故事吧(第一弹)</a>
<ul>
<li><a href="#from-wechat-bot-to-telegram-bot">From Wechat bot to Telegram bot</a></li>
<li><a href="#combine-telegrambotapi-with-wechat-go">Combine telegrambotapi with wechat-go</a></li>
<li><a href="#use-telegrambotapi">Use telegrambotapi</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#reference">Reference</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="嘛-说说我和astral的故事吧-第一弹">嘛,说说我和Astral的故事吧(第一弹)</h1>

<h2 id="from-wechat-bot-to-telegram-bot">From Wechat bot to Telegram bot</h2>

<p>在序篇中,我曾提到写Astral的初衷是个Wechat Bot,所以,在引入了wechat-go的依赖之后,这次转移必须要在尽量少改代码的情况下完成。</p>

<p>因为wechat-go&rdquo;<strong>把所有新的feature都当做plugin</strong>&ldquo;的设计模式,使得这次转变异常轻松,这也是我在序中说wechat-go代码清晰的主要原因。接下来,我要做的就没有想象的那么复杂了,甚至文件目录都不用变。只要把底层的包从wechat的sdk换成Telegram的sdk就可以了。</p>

<p>然而,为了祭奠自己之前死去的脑细胞,我还是在Astral中留下了wechat-go.</p>

<p>换句话说,在astral-plugin下的<strong>逻辑</strong>都是可以被复用的。</p>

<h2 id="combine-telegrambotapi-with-wechat-go">Combine telegrambotapi with wechat-go</h2>

<p>在GitHub找了一圈Telegram SDK的Go实现,最后还是选了<a href="https://github.com/Syfaro">@Syfaro</a>的<a href="https://github.com/go-telegram-bot-api/telegram-bot-api">telegram-bot-api</a>,并且加入了Telegram bot API group。</p>

<p>tgbotapi实现了大多数Telegram Bot的大多数功能,但是从提供的demo看,貌似需要把Register和feature的逻辑写在一块。所以,我开始着手抽象tgbotapi的实现逻辑,让其可以达到和wechat-go一样非常方便扩展的效果。</p>

<p>以代码为例,可以看到demo中的代码是酱紫的:</p>

<pre><code>updates := bot.ListenForWebhook(&quot;/&quot; + bot.Token)

    for update := range updates {
        log.Printf(&quot;%+v\n&quot;, update)
    }
</code></pre>

<p>作为demo,这样没啥问题,但是如果所有feature写在<code>range updates</code> 的for循环里面,这样代码的扩展性会非常糟糕,并且代码结构也不够优雅。</p>

<p>参照着wechat-go的实现 以及 一点自己的想法,最后这边代码会变成这个样子:</p>

<pre><code>for update := range updatesMsgChannel {
        log.Printf(&quot;[raw msg]:%+v\n&quot;, update)

        if update.Message == nil {
            continue
        }
        var msg tgbotapi.MessageConfig
        msg = plugin.RegistTGEnabledPlugins(update.Message)
        //default msg
        if msg.Text == &quot;&quot; || msg.ChatID == 0 {
            msg = tgbotapi.NewMessage(update.Message.Chat.ID, update.Message.Text)
        }
        msg.ReplyToMessageID = update.Message.MessageID
        bot.Send(msg)
    }
</code></pre>

<p>这样会让代码清晰很多,并且这边的实现在之后迭代新的feature时也不用改了。把改动限制在增加代码,而非改动代码上了。</p>

<h2 id="use-telegrambotapi">Use telegrambotapi</h2>

<p>Telegram Server 和 部署Bot的Server 的通讯是基于HTTPS,所以需要给自己的VPS上HTTPS证书。</p>

<ul>
<li>Setup HTTPS Server</li>
</ul>

<p>给自己的服务器添加HTTPS证书,可以参照着<a href="https://certbot.eff.org/">Lets encrypt的certbot设置教程</a>一步一步下去。</p>

<p>对于Telegram Bot,也可以使用自签证书。</p>

<pre><code>  openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 3560 -subj &quot;//O=Org\CN=Test&quot; -nodes
</code></pre>

<ul>
<li>Reverse Proxy (nginx)</li>
</ul>

<p>给自己的服务器设置好HTTPS证书之后,就可以保证Telegram Server和自己的Server通讯正常了。</p>

<p>然而Astral的Listen Server是HTTP的,所以,需要把Telegram Server发来的请求代理到Astral Listen Port,只需要给<code>nginx.conf</code> 加上一条反代规则:</p>

<pre><code>            location /{
                    #PORT是telegram bot监听的端口
           proxy_pass http://127.0.0.1:PORT;
         }
</code></pre>

<p>这样Astral就可以顺利接收到Telegram的请求了。</p>

<ul>
<li>Test Your Bot</li>
</ul>

<p>对telegrambotapi的demo稍加改造,我们就可以得到一个基于<code>webhook</code>的一个可运行版本:</p>

<pre><code>  //ListenWebHook is the tg api webhook mode
  func ListenWebHook(debug bool) (err error) {
    bot, err := connectTG()
    if err != nil {
        return
    }
    if debug {
        bot.Debug = true
        log.Printf(&quot;bot auth passed as %s&quot;, bot.Self.UserName)
    }
    bot.RemoveWebhook()
    cert := getcert.NewDomainCert(tgAPIDomain)
    domainWithToken := fmt.Sprintf(&quot;%s%s&quot;, cert.GetDomain(), token)
    if _, err = bot.SetWebhook(tgbotapi.NewWebhook(domainWithToken)); err != nil {
        log.Printf(&quot;notify webhook failed:%s&quot;, err.Error())
        return
    }

    info, err := bot.GetWebhookInfo()
    if err != nil {
        log.Panicln(err)
    }
    log.Println(info.LastErrorMessage, info.LastErrorDate)

    pattern := fmt.Sprintf(&quot;/%s&quot;, token)
    updatesMsgChannel := bot.ListenForWebhook(pattern)
    log.Printf(&quot;msg in channel:%d&quot;, len(updatesMsgChannel))

    port := fmt.Sprintf(&quot;:%s&quot;, os.Getenv(&quot;LISTENPORT&quot;))

    go http.ListenAndServe(port, nil)

    for update := range updatesMsgChannel {
        log.Printf(&quot;[raw msg]:%+v\n&quot;, update)

        if update.Message == nil {
            continue
        }
        var msg tgbotapi.MessageConfig

        if msg.Text == &quot;&quot; || msg.ChatID == 0 {
            msg = tgbotapi.NewMessage(update.Message.Chat.ID, update.Message.Text)
        }
        msg.ReplyToMessageID = update.Message.MessageID
        bot.Send(msg)
    }

    return
  }
</code></pre>

<p>这边值得一提的是,Telegram的bot token需要跟@botfather PY一下,才可以获得。</p>

<p>然后,代码中的<code>domainWithToken</code>就是你的域名或者IP(也就是上一步设置的反代路径)后加上申请得到的<code>Token</code>.</p>

<ul>
<li>Don&rsquo;t Have Own VPS</li>
</ul>

<p>理论上使用<code>long pulling</code>的方式部署在本地应该也可以。即用一个goroutine隔一段时间去向TG Server请求message。如果checkpoint设置短的话,也可以达到<code>webhook</code>的效果。</p>

<h2 id="conclusion">Conclusion</h2>

<p>这一章主要介绍了 <strong>一些tgbotapi的使用技巧</strong> 和 <strong>在VPS上配置TG bot的相关信息</strong> 。</p>

<p>以上,应该就可以让Bot demo运行起来了。</p>

<p>下一章,会主要侧重一个具体的plugin来讨论。</p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="https://core.telegram.org/bots/api#getting-updates">Telegram Bot Doc</a></li>
<li><a href="https://github.com/go-telegram-bot-api/telegram-bot-api/blob/master/README.md">Go TG Bot API</a></li>
<li><a href="https://github.com/python-telegram-bot/python-telegram-bot/wiki/Webhooks">Python Telegram Bot Wiki</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">scnace</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        0001-01-01
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/astral/">Astral</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%90%86%E6%B1%A0/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">关于代理池</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/astral-0ea3c4c0-acbf-48be-a1af-9660474dd0e2/">
            <span class="next-text nav-default">嘛,说说我与Astral的故事吧(第零弹)</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:scbizu@gamil.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/scnace" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/scbizu" class="iconfont icon-github" title="github"></a>
  <a href="https://blog.scnace.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">copyleft</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
